server {
    listen 80;
    server_name localhost;

    root /var/www/html;
    index index.php;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    client_max_body_size 100M;

    # Protect .git and other hidden files
    # Left logging for fail2ban
    location ~ /\. {
        deny all;
    }


    # Static content
    location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|woff2|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
        gzip on;
        gzip_static on;
        gzip_disable "MSIE [1-6]\.(?!.*SV1)";
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.0;
        gzip_types
        text/plain
        text/css
        text/js
        text/xml
        text/x-component
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;
        expires max;

        try_files $uri =404;
    }

    # Static content
    location ~* ^.+\.(js|css)$ {
        gzip on;
        gzip_static on;
        gzip_disable "MSIE [1-6]\.(?!.*SV1)";
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.0;
        gzip_types
        text/plain
        text/css
        text/js
        text/xml
        text/x-component
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;
        expires 14d;

        try_files $uri =404;
    }

    #
    # Magic start here
    #

    # Enable SSI
    # https://en.wikipedia.org/wiki/Server_Side_Includes
    #ssi on;
    # Enable caching for all by default
    set $skip_cache 0;

    # Disable cache for all requests except GET and HEAD
    if ($request_method !~ ^(GET|HEAD)$) {
        set $no_cache "1";
    }

    # Disable cache for all requests with a query string
    # You should disable this section if you use query string only for users tracking
    if ($query_string != "") {
        set $no_cache 1;
    }

    # Disable cache for all logged in users or recent commenters
    # Add your custom cookies here!
    if ($http_cookie ~* "nginx_no_cache|PHPSESSID") {
        set $skip_cache 1;
    }
    # Wordpress
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $skip_cache 1;
    }
    # Magento
    if ($http_cookie ~* "frontend_cid|frontend|sid|adminhtml|EXTERNAL_NO_CACHE") {
        set $skip_cache 1;
    }

    # Disable cache for uris containing the following segments
    # If is evil and you can speedup this section by using locations instead
    # https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/
    # https://serverfault.com/questions/509327/can-we-jump-to-another-location-from-a-location-in-nginx
    # Best practice
    if ($request_uri ~* "/ping|/metrics|/nginx_status|/admin|/login|/feed|index.php|sitemap(_index)?.xml") {
        set $skip_cache 1;
    }
    # Wordpress
    if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
        set $skip_cache 1;
    }
    # Magento
    # I copied this from varnish example
    # Better use varnish with magento autogenerated config instead
    # http://devdocs.magento.com/guides/v2.0/config-guide/varnish/config-varnish.html
    if ($request_uri ~* "(index|litespeed).php|admin|api|cron.php|/checkout/|/account/|/brand-ambassador/|/brand-ambassador-coupon/|/brand-ambassador-program/|/affiliateplusstatistic/|/brand-ambassador/index/listTransaction/|/brand-ambassador/index/paymentForm/|/brand-ambassador-program/index/index/|/brand-ambassador/banner/list/|/brand-ambassador-coupon/index/index/|/brand-ambassador/refer/index/|/brand-ambassador/index/payments/|/brand-ambassador/index/referrers/|/affiliateplusstatistic/statistic/index/|/brand-ambassador/account/edit/|/checkout/cart/|/repeat-delivery") {
        set $skip_cache 1;
    }


    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        # Disable cache for all requests except GET and HEAD
        # And add our cookie for preventing caching for this user for next 5s
        # So user would see the changes
        if ($request_method !~ ^(GET|HEAD)$) {
            set $no_cache "1";

            add_header Set-Cookie "nginx_no_cache=1; Max-Age=5; Path=/";
            add_header X-Microcachable "0";
        }

        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wp:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_valid 499 502 503 1m;
        fastcgi_cache_valid 404 15m;
        fastcgi_cache_valid any 15m;
    }

    # WebP Express rules
    # --------------------
    location ~* ^/?wp-content/.*\.(png|jpe?g)$ {
        add_header Vary Accept;
        expires 365d;
        if ($http_accept !~* "webp") {
            break;
        }
        try_files
        /wp-content/webp-express/webp-images/doc-root/$uri.webp
        $uri.webp
        /wp-content/plugins/webp-express/wod/webp-on-demand.php?xsource=x$request_filename&wp-content=wp-content
        ;
    }

    # Route requests for non-existing webps to the converter
    location ~* ^/?wp-content/.*\.(png|jpe?g)\.webp$ {
        try_files
        $uri
        /wp-content/plugins/webp-express/wod/webp-realizer.php?xdestination=x$request_filename&wp-content=wp-content
        ;
    }
    # ------------------- (WebP Express rules ends here)

    # W3 total cache minify
    location ~ ^/wp-content/cache/minify/[^/]+/(.*)$ {
        try_files $uri /wp-content/plugins/w3-total-cache/pub/minify.php?file=$1;
    }

    # BEGIN W3TC Minify core
        rewrite ^/wp-content/cache/minify/ /index.php last;
    # END W3TC Minify core

}
